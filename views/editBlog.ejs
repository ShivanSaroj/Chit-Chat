<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <%- include('./partials/head') %>
    <title>Edit Blog Post</title>
    <!-- Quill.js CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>
<body class="bg-body-tertiary">
    <%- include('./partials/nav') %>
    
    <main class="container py-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header">
                        <h3 class="mb-0">Edit Blog Post</h3>
                    </div>
                    <div class="card-body">
                        <form id="editBlogForm" action="/blog/edit/<%= blog._id %>" method="POST" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="title" class="form-label">Title</label>
                                <input type="text" class="form-control" id="title" name="title" 
                                       value="<%= blog.title %>" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="body" class="form-label">Content</label>
                                <div id="editor" style="height: 300px;"></div>
                                <textarea name="body" id="body" style="display: none;"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="coverImage" class="form-label">Cover Image</label>
                                <input type="file" class="form-control" id="coverImage" name="coverImage" accept="image/*">
                                <div class="form-text">Leave empty to keep current image</div>
                                <% if (blog.coverImageURL) { %>
                                    <div class="mt-2">
                                        <small class="text-muted">Current image:</small><br>
                                        <img src="<%= blog.coverImageURL %>" alt="Current cover" class="img-thumbnail" style="max-width: 200px;">
                                    </div>
                                <% } %>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">Update Post</button>
                                <a href="/blog/<%= blog._id %>" class="btn btn-secondary">Cancel</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <%- include('./partials/script') %>
    <!-- Quill.js JavaScript -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script>
        var quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'align': [] }],
                    ['link', 'image'],
                    ['clean']
                ]
            }
        });

        // Custom image handler
        quill.getModule('toolbar').addHandler('image', function() {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();

            input.onchange = function() {
                const file = input.files[0];
                if (file) {
                    console.log('File selected:', file.name);
                    const formData = new FormData();
                    formData.append('image', file);

                    // Show loading indicator
                    const range = quill.getSelection();
                    quill.insertText(range.index, 'Uploading image...', 'italic', true);

                    fetch('/blog/upload-image', {
                        method: 'POST',
                        body: formData,
                        credentials: 'include'
                    })
                    .then(response => {
                        console.log('Response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Upload response:', data);
                        
                        // Remove loading text
                        const currentRange = quill.getSelection();
                        quill.deleteText(range.index, 'Uploading image...'.length);
                        
                        if (data.success) {
                            quill.insertEmbed(range.index, 'image', data.imageUrl);
                            console.log('Image inserted:', data.imageUrl);
                        } else {
                            alert('Image upload failed: ' + (data.message || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // Remove loading text
                        const currentRange = quill.getSelection();
                        quill.deleteText(range.index, 'Uploading image...'.length);
                        alert('Image upload failed');
                    });
                }
            };
        });

        // Set existing content
        quill.root.innerHTML = `<%= blog.body %>`;

        // Update hidden textarea when form is submitted
        document.getElementById('editBlogForm').addEventListener('submit', function() {
            document.getElementById('body').value = quill.root.innerHTML;
        });
    </script>
</body>
</html>


